<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barlas' Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/059669/ffffff?text=Barlasiko">
    <script>
        // Tailwind CSS Configuratie
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        /* Aangepaste stijlen */
        body { -ms-overflow-style: none; scrollbar-width: none; }
        body::-webkit-scrollbar { display: none; }
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .log-item-new { animation: fadeIn 0.5s ease-out; }
        .prose { max-width: none; }
        #copyFeedback {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Voorkomt interactie wanneer onzichtbaar */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-sans transition-colors duration-300">

    <!-- Welkomstscherm -->
    <div id="welcomeScreen" class="container mx-auto max-w-lg p-4 min-h-screen flex flex-col justify-center items-center text-center">
        <div class="glass-card p-8 rounded-2xl shadow-2xl w-full">
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Welkom bij Barlas' Tracker</h1>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Synchroniseer de data tussen meerdere apparaten.</p>
            <div id="welcomeActions">
                <button id="createFamilyBtn" class="w-full bg-blue-500 text-white font-semibold px-4 py-3 rounded-lg hover:bg-blue-600 transition-colors mb-4 text-lg">
                    Nieuwe Familie Starten
                </button>
                <div class="space-y-2">
                    <input id="familyIdInput" type="text" placeholder="Voer Familie ID in" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="joinFamilyBtn" class="w-full bg-green-500 text-white font-semibold px-4 py-3 rounded-lg hover:bg-green-600 transition-colors">
                        Deelnemen aan Familie
                    </button>
                </div>
            </div>
            <p id="joinError" class="text-red-500 mt-2 hidden">ID niet gevonden.</p>
            <p id="initError" class="text-red-500 font-semibold mt-4 hidden"></p>
        </div>
    </div>

    <!-- Hoofd App -->
    <div id="app" class="container mx-auto max-w-lg p-4 min-h-screen hidden">
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Barlas' Tracker</h1>
            <button id="darkModeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
                <svg id="sunIcon" class="text-slate-800" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg id="moonIcon" class="hidden text-slate-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </header>
        <div id="loadingApp" class="text-center text-slate-500 dark:text-slate-400 py-10" style="display: none;">
            <p>App aan het laden...</p>
        </div>

        <div id="appContent" class="hidden">
            <div class="mb-4 p-3 glass-card rounded-lg text-center">
                <p class="text-sm text-slate-600 dark:text-slate-300">Familie ID: <strong id="familyIdDisplay" class="font-mono"></strong></p>
                <div class="mt-2 flex justify-center items-center space-x-4">
                    <button id="copyFamilyId" class="text-blue-500 text-sm hover:underline">Kopieer</button>
                    <button id="leaveFamily" class="text-yellow-600 dark:text-yellow-400 text-sm hover:underline">Verlaat</button>
                    <button id="deleteFamily" class="text-red-500 text-sm hover:underline">Verwijder Familie</button>
                </div>
            </div>

            <div id="activeTimers" class="mb-6 space-y-2"></div>

            <div class="grid grid-cols-4 gap-4 mb-8">
                <button id="voedingBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üçº</span><span class="font-semibold">Voeding</span>
                </button>
                 <button id="kolfBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üß¥</span><span class="font-semibold">Kolf</span>
                </button>
                <button id="luierBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üíß</span><span class="font-semibold">Luier</span>
                </button>
                <button id="slaapBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üò¥</span><span class="font-semibold">Slaap</span>
                </button>
                <button id="metingBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üìè</span><span class="font-semibold">Meting</span>
                </button>
                <button id="noiseBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üåä</span><span class="font-semibold">Noise</span>
                </button>
                <button id="songBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üéµ</span><span class="font-semibold">Ninni</span>
                </button>
            </div>

            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Logboek</h2>
                    <button id="summaryBtn" class="bg-purple-500 text-white text-sm font-semibold px-3 py-2 rounded-lg hover:bg-purple-600 transition-colors flex items-center space-x-2">
                        <span>Dag Samenvatting</span>
                        <span class="text-lg">‚ú®</span>
                    </button>
                </div>
                <div id="logbook" class="space-y-3">
                    <p id="emptyLogMessage" class="text-center text-slate-500 dark:text-slate-400 py-4">Nog geen activiteiten gelogd.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="copyFeedback">ID gekopieerd!</div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div id="createFamilyModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-sm hidden">
            <h3 class="text-xl font-bold mb-4">Kies een Familie ID</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-4">Kies een unieke en makkelijk te onthouden ID (bv. 'familie-barlas'). Gebruik alleen letters, cijfers en streepjes.</p>
            <input id="createFamilyIdInput" type="text" placeholder="Kies uw unieke ID" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p id="createIdError" class="text-red-500 mt-2 text-sm hidden">Deze ID is al in gebruik. Kies een andere.</p>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="saveNewFamilyBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Aanmaken & Starten</button>
            </div>
        </div>
         <div id="kolfModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4">Kolfsessie Registreren</h3>
            <div class="space-y-4">
                 <div>
                    <label for="kolfDatum" class="font-semibold mb-1 block text-sm">Datum</label>
                    <input id="kolfDatum" type="date" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="font-semibold mb-1 block text-sm">Tijd</label>
                    <div class="flex items-center space-x-2">
                        <input id="kolfTijdUur" type="number" min="0" max="23" placeholder="UU" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                        <span class="font-bold text-slate-500 dark:text-slate-400">:</span>
                        <input id="kolfTijdMinuut" type="number" min="0" max="59" placeholder="MM" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    </div>
                </div>
                <div>
                    <label for="kolfMl" class="font-semibold mb-1 block text-sm">Hoeveelheid (ml)</label>
                    <input id="kolfMl" type="number" placeholder="ml" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="saveKolf" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Opslaan</button>
            </div>
        </div>
        <div id="voedingModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4">Flesvoeding Registreren</h3>
            <div class="space-y-4">
                <div>
                    <label for="flesDatum" class="font-semibold mb-1 block text-sm">Datum</label>
                    <input id="flesDatum" type="date" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="font-semibold mb-1 block text-sm">Tijd</label>
                    <div class="flex items-center space-x-2">
                        <input id="flesTijdUur" type="number" min="0" max="23" placeholder="UU" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                        <span class="font-bold text-slate-500 dark:text-slate-400">:</span>
                        <input id="flesTijdMinuut" type="number" min="0" max="59" placeholder="MM" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    </div>
                </div>
                <div>
                    <label for="flesMl" class="font-semibold mb-1 block text-sm">Hoeveelheid (ml)</label>
                    <input id="flesMl" type="number" placeholder="ml" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="saveFles" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Opslaan</button>
            </div>
        </div>
        <div id="luierModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4">Luier Registreren</h3>
            <div class="grid grid-cols-1 gap-3">
                <button data-type="nat" class="luier-keuze-btn bg-yellow-400 text-white px-4 py-3 rounded-lg text-lg hover:bg-yellow-500">Natte luier</button>
                <button data-type="vies" class="luier-keuze-btn bg-amber-600 text-white px-4 py-3 rounded-lg text-lg hover:bg-amber-700">Vieze luier</button>
                <button data-type="beide" class="luier-keuze-btn bg-red-500 text-white px-4 py-3 rounded-lg text-lg hover:bg-red-600">Beide</button>
            </div>
            <button class="modal-close mt-6 w-full bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
        </div>
        <div id="metingModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4">Meting Registreren</h3>
            <div class="space-y-4">
                <div>
                    <label for="gewichtInput" class="font-semibold mb-1 block">Gewicht (gram)</label>
                    <input id="gewichtInput" type="number" placeholder="e.g. 3500" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="lengteInput" class="font-semibold mb-1 block">Lengte (cm)</label>
                    <input id="lengteInput" type="number" placeholder="e.g. 52" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="saveMeting" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Opslaan</button>
            </div>
        </div>
        <div id="noiseModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4">White Noise</h3>
            <div class="text-center">
                <button id="playNoiseBtn" class="bg-blue-500 text-white font-bold py-4 px-6 rounded-full text-2xl hover:bg-blue-600 transition-colors">
                    ‚ñ∂Ô∏è Play
                </button>
                <p class="text-sm mt-4 text-slate-500 dark:text-slate-400">Laat open om af te spelen</p>
            </div>
            <button class="modal-close mt-6 w-full bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Sluiten</button>
        </div>
        <div id="summaryModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <span class="text-lg mr-2">‚ú®</span> Dagelijkse Samenvatting
            </h3>
            <div id="summaryContent" class="text-slate-700 dark:text-slate-300 space-y-3 prose dark:prose-invert">
                <!-- Loading indicator and content will go here -->
            </div>
            <button class="modal-close mt-6 w-full bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Sluiten</button>
        </div>
        <div id="confirmDeleteModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-sm hidden">
            <h3 class="text-xl font-bold mb-2">Item Verwijderen</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Weet je zeker dat je dit item definitief wilt verwijderen?</p>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="confirmDeleteBtn" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Ja, verwijder</button>
            </div>
        </div>
        <div id="confirmLeaveModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-sm hidden">
            <h3 class="text-xl font-bold mb-2">Familie Verlaten</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Weet je zeker dat je wilt uitloggen? Je hebt de ID nodig om opnieuw deel te nemen.</p>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="confirmLeaveBtn" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Ja, verlaat</button>
            </div>
        </div>
        <div id="confirmDeleteFamilyModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-sm hidden">
            <h3 class="text-xl font-bold mb-2">Familie Verwijderen</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Weet u zeker dat u deze familie en <strong>alle</strong> bijbehorende gegevens permanent wilt verwijderen? Dit kan niet ongedaan worden gemaakt.</p>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="confirmDeleteFamilyBtn" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Ja, verwijder definitief</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs - Gebruik van de moderne modulaire versie -->
    <script type="module">
        // Importeer de benodigde functies van de Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, getDoc, addDoc, serverTimestamp, deleteDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Globale Variabelen ---
        let db, auth, familyId, userId;
        let logUnsubscribe, timersUnsubscribe, profileUnsubscribe;
        let localTimerInterval = null;
        let audioContext;
        let currentLogs = [];

        // --- Firebase Configuratie ---
        const publicFirebaseConfig = {
            apiKey: "AIzaSyDiV4yES2wlXXwfedmrIifFD_LsrqYYhyE",
            authDomain: "barlasiko.firebaseapp.com",
            projectId: "barlasiko",
            storageBucket: "barlasiko.appspot.com", // Corrected value
            messagingSenderId: "725405275035",
            appId: "1:725405275035:web:d93c6bbaebedd35ec5873e",
            measurementId: "G-QFPEF8BT04"
        };
        
        // Gebruik de specifieke config als die wordt aangeleverd, anders de publieke.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : publicFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elementen ---
        const welcomeScreen = document.getElementById('welcomeScreen');
        const welcomeActionsEl = document.getElementById('welcomeActions');
        const initErrorEl = document.getElementById('initError');
        const appScreen = document.getElementById('app');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const logbookEl = document.getElementById('logbook');
        const emptyLogMessage = document.getElementById('emptyLogMessage');
        const activeTimersEl = document.getElementById('activeTimers');
        const modalContainer = document.getElementById('modal-container');
        const modals = {
            createFamily: document.getElementById('createFamilyModal'),
            voeding: document.getElementById('voedingModal'),
            kolf: document.getElementById('kolfModal'),
            luier: document.getElementById('luierModal'),
            meting: document.getElementById('metingModal'),
            noise: document.getElementById('noiseModal'),
            summary: document.getElementById('summaryModal'),
            confirmDelete: document.getElementById('confirmDeleteModal'),
            confirmLeave: document.getElementById('confirmLeaveModal'),
            confirmDeleteFamily: document.getElementById('confirmDeleteFamilyModal'),
        };
        const copyFeedback = document.getElementById('copyFeedback');
        const mainAppButtons = document.querySelectorAll('#appContent .glass-card button, #appContent #summaryBtn');
        const loadingAppEl = document.getElementById('loadingApp');

        // --- GELUID FUNCTIES ---
        let isNoisePlaying = false;
        let noiseNode;
        const playNoiseBtn = document.getElementById('playNoiseBtn');

        function setupAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function toggleWhiteNoise() {
            setupAudioContext();
            if (isNoisePlaying) {
                if(noiseNode) noiseNode.stop();
                isNoisePlaying = false;
                playNoiseBtn.textContent = '‚ñ∂Ô∏è Play';
            } else {
                const bufferSize = 2 * audioContext.sampleRate;
                const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
                noiseNode = audioContext.createBufferSource();
                noiseNode.buffer = noiseBuffer;
                noiseNode.loop = true;
                noiseNode.connect(audioContext.destination);
                noiseNode.start(0);
                isNoisePlaying = true;
                playNoiseBtn.textContent = '‚è∏Ô∏è Pause';
            }
        }
        if(playNoiseBtn) playNoiseBtn.addEventListener('click', toggleWhiteNoise);
        
        // --- WIEGELIEDJE FUNCTIES ---
        let isLullabyPlaying = false;
        let stopLullabyCallback = () => {};

        const notes = { 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'REST': 0 };
        const lullabyMelody = [
            { note: 'G4', duration: 0.3 }, { note: 'G4', duration: 0.3 }, { note: 'G4', duration: 0.3 }, { note: 'A4', duration: 0.4 },
            { note: 'G4', duration: 0.3 }, { note: 'F4', duration: 0.3 }, { note: 'E4', duration: 0.6 }, { note: 'REST', duration: 0.2 },
            { note: 'F4', duration: 0.3 }, { note: 'F4', duration: 0.3 }, { note: 'F4', duration: 0.3 }, { note: 'G4', duration: 0.4 },
            { note: 'F4', duration: 0.3 }, { note: 'E4', duration: 0.3 }, { note: 'D4', duration: 0.6 }, { note: 'REST', duration: 0.4 },
        ];

        async function playLullaby() {
            setupAudioContext();
            if (isLullabyPlaying) return;
            isLullabyPlaying = true;

            const songBtn = document.getElementById('songBtn');
            const textEl = songBtn.querySelector('span:last-child');
            textEl.textContent = 'Stop Ninni';
            songBtn.classList.add('bg-red-200', 'dark:bg-red-800/50');

            let shouldStop = false;
            stopLullabyCallback = () => { shouldStop = true; };

            while (!shouldStop) {
                 for (const part of lullabyMelody) {
                    if (shouldStop) break;
                    if (part.note !== 'REST') {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(notes[part.note], audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + part.duration);
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + part.duration);
                    }
                    await new Promise(resolve => setTimeout(resolve, part.duration * 1000));
                }
            }

            isLullabyPlaying = false;
            stopLullabyCallback = () => {};
            textEl.textContent = 'Ninni';
            songBtn.classList.remove('bg-red-200', 'dark:bg-red-800/50');
        }

        // --- APP INITIALISATIE ---
        document.addEventListener('DOMContentLoaded', () => {
            setupDarkMode();
            initializeAppAndAuth();
        });

        function initializeAppAndAuth() {
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIzaSy")) {
                 if (firebaseConfig.apiKey === "AIzaSyDiV4yES2wlXXwfedmrIifFD_LsrqYYhyE") {
                    initErrorEl.innerHTML = `<strong>App kan niet verbinden.</strong><br>Vervang de voorbeeld-configuratie in de code met je eigen Firebase-gegevens.`;
                    initErrorEl.style.display = 'block';
                    welcomeActionsEl.style.display = 'none';
                    return;
                }
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        if (profileUnsubscribe) profileUnsubscribe();
                        const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                        
                        profileUnsubscribe = onSnapshot(profileRef, (docSnap) => {
                            const data = docSnap.data();
                            if (data && data.familyId) {
                                familyId = data.familyId;
                                showApp();
                            } else {
                                familyId = null;
                                showWelcome();
                            }
                        });
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialisatie mislukt:", e);
                initErrorEl.textContent = 'Kon niet verbinden met de server. Controleer je internetverbinding en de Firebase-configuratie.';
                initErrorEl.style.display = 'block';
                welcomeActionsEl.style.display = 'none';
            }
        }

        // --- UI FUNCTIES (SCHERMEN WISSELEN) ---
        function showWelcome() {
            if (appScreen) appScreen.style.display = 'none';
            if (welcomeScreen) welcomeScreen.style.display = 'flex';
        }

        async function showApp() {
            if (!familyId) return;
            loadingAppEl.style.display = 'block';
            document.getElementById('appContent').style.display = 'none';
            updateButtonState(false);
            
            document.getElementById('familyIdDisplay').textContent = familyId;

            if (welcomeScreen) welcomeScreen.style.display = 'none';
            if (appScreen) appScreen.style.display = 'block';

            // Stop vorige listeners
            if (logUnsubscribe) logUnsubscribe();
            if (timersUnsubscribe) timersUnsubscribe();

            // Luister naar logboek updates
            const logsRef = collection(db, `artifacts/${appId}/public/data/families_public/${familyId}/logs`);
            logUnsubscribe = onSnapshot(logsRef, (snapshot) => {
                currentLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentLogs.sort((a, b) => {
                    if (!a.timestamp || !b.timestamp) return 0;
                    return b.timestamp.toMillis() - a.timestamp.toMillis();
                });
                renderLog(currentLogs);
                loadingAppEl.style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                updateButtonState(true);
            }, (error) => {
                console.error("Firestore (logs) leesfout:", error);
                 initErrorEl.innerHTML = `<strong>Fout bij laden van data.</strong><br>Controleer de Firestore Security Rules.`;
                 initErrorEl.style.display = 'block';
            });

            // Luister naar timer updates
            const timersRef = doc(db, `artifacts/${appId}/public/data/families_public/${familyId}/state/timers`);
            timersUnsubscribe = onSnapshot(timersRef, (docSnap) => {
                const timers = docSnap.data() || {};
                renderActiveTimers(timers);
                updateSlaapButton(timers);
            }, (error) => {
                console.error("Firestore (timers) leesfout:", error);
            });
        }
        
        function updateButtonState(isEnabled) {
            mainAppButtons.forEach(btn => {
                btn.disabled = !isEnabled;
                btn.classList.toggle('opacity-50', !isEnabled);
                btn.classList.toggle('cursor-not-allowed', !isEnabled);
            });
        }
        
        // --- FAMILIE ID LOGICA ---
        document.getElementById('createFamilyBtn').addEventListener('click', () => openModal(modals.createFamily));

        document.getElementById('saveNewFamilyBtn').addEventListener('click', async () => {
            const idInput = document.getElementById('createFamilyIdInput');
            const newId = idInput.value.trim().toLowerCase();
            const errorEl = document.getElementById('createIdError');

            if (!newId || !/^[a-z0-9-]+$/.test(newId)) {
                errorEl.textContent = 'Gebruik alleen letters, cijfers en streepjes.';
                errorEl.style.display = 'block';
                return;
            }

            const familyDocRef = doc(db, `artifacts/${appId}/public/data/families_public/${newId}`);
            const familyDoc = await getDoc(familyDocRef);
            if (familyDoc.exists()) {
                errorEl.textContent = 'Deze ID is al in gebruik. Kies een andere.';
                errorEl.style.display = 'block';
            } else {
                familyId = newId;
                await setDoc(familyDocRef, { createdAt: serverTimestamp() });
                const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                await setDoc(profileRef, { familyId }, { merge: true });
                closeModal();
            }
        });

        document.getElementById('joinFamilyBtn').addEventListener('click', async () => {
            const inputId = document.getElementById('familyIdInput').value.trim();
            if (!inputId) return;
            const familyDocRef = doc(db, `artifacts/${appId}/public/data/families_public/${inputId}`);
            const familyDoc = await getDoc(familyDocRef);
            if (familyDoc.exists()) {
                const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                await setDoc(profileRef, { familyId: inputId }, { merge: true });
            } else {
                const errorEl = document.getElementById('joinError');
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 3000);
            }
        });
        
        document.getElementById('copyFamilyId').addEventListener('click', () => {
            navigator.clipboard.writeText(familyId).then(() => {
                copyFeedback.style.opacity = 1;
                setTimeout(() => { copyFeedback.style.opacity = 0; }, 2000);
            });
        });

        document.getElementById('leaveFamily').addEventListener('click', () => openModal(modals.confirmLeave));
        document.getElementById('deleteFamily').addEventListener('click', () => openModal(modals.confirmDeleteFamily));
        
        document.getElementById('confirmLeaveBtn').addEventListener('click', async () => {
            const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
            await setDoc(profileRef, { familyId: null }, { merge: true });
            closeModal();
            showWelcome();
        });

        document.getElementById('confirmDeleteFamilyBtn').addEventListener('click', async () => {
            if (!familyId) return;
            const familyDocRef = doc(db, `artifacts/${appId}/public/data/families_public/${familyId}`);
            await deleteDoc(familyDocRef);
            const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
            await updateDoc(profileRef, { familyId: deleteField() });
            closeModal();
        });


        // --- RENDER FUNCTIES ---
        function renderLog(log = []) {
            logbookEl.innerHTML = '';
            if (log.length === 0) {
                emptyLogMessage.style.display = 'block';
                logbookEl.appendChild(emptyLogMessage);
            } else {
                emptyLogMessage.style.display = 'none';
                let lastDateString = null;

                log.forEach((item, index) => {
                    if (!item.timestamp) return;
                    const itemDate = item.timestamp.toDate();
                    const itemDateLocaleString = itemDate.toLocaleDateString('nl-BE');

                    if (itemDateLocaleString !== lastDateString) {
                        const dateHeader = document.createElement('div');
                        dateHeader.className = 'text-center text-sm font-semibold text-slate-500 dark:text-slate-400 py-2 my-2 sticky top-0 bg-gray-100/80 dark:bg-slate-900/80 backdrop-blur-sm z-10';
                        const today = new Date();
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);

                        if (today.toLocaleDateString('nl-BE') === itemDateLocaleString) dateHeader.textContent = 'Vandaag';
                        else if (yesterday.toLocaleDateString('nl-BE') === itemDateLocaleString) dateHeader.textContent = 'Gisteren';
                        else dateHeader.textContent = itemDate.toLocaleDateString('nl-BE', { weekday: 'long', day: 'numeric', month: 'long' });
                        
                        logbookEl.appendChild(dateHeader);
                        lastDateString = itemDateLocaleString;
                    }

                    const div = document.createElement('div');
                    div.className = 'glass-card p-4 rounded-xl flex items-center space-x-4 shadow-md';
                    if (index === 0) div.classList.add('log-item-new');

                    const { icon, text } = getLogItemContent(item);
                    const time = itemDate.toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });

                    div.innerHTML = `
                        <span class="text-3xl">${icon}</span>
                        <div class="flex-grow">
                            <p class="font-medium">${text}</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">${time}</p>
                        </div>
                        <button data-id="${item.id}" class="delete-log-item p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-500 hover:text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>`;
                    logbookEl.appendChild(div);
                });
            }
        }

        function getLogItemContent(item) {
            switch(item.type) {
                case 'VOEDING_FLES': return { icon: 'üçº', text: `Flesvoeding: ${item.data.ml} ml` };
                case 'KOLF': return { icon: 'üß¥', text: `Gekolfd: ${item.data.ml} ml` };
                case 'LUIER':
                    const luierText = { nat: 'Natte luier', vies: 'Vieze luier', beide: 'Natte & vieze luier' };
                    return { icon: 'üíß', text: luierText[item.data.type] };
                case 'SLAAP': return { icon: 'üò¥', text: `Slaap: ${formatDuration(item.data.duration)}` };
                case 'METING':
                    let metingText = [];
                    if (item.data.gewicht) metingText.push(`${item.data.gewicht} g`);
                    if (item.data.lengte) metingText.push(`${item.data.lengte} cm`);
                    return { icon: 'üìè', text: `Meting: ${metingText.join(', ')}` };
                default: return { icon: '‚ùì', text: 'Onbekende activiteit' };
            }
        }
        
        function renderActiveTimers(timers = {}) {
            activeTimersEl.innerHTML = '';
            if (localTimerInterval) clearInterval(localTimerInterval);

            if (timers.slaap && timers.slaap.startTime) {
                const startTime = timers.slaap.startTime.toDate();
                const timerEl = document.createElement('div');
                timerEl.className = 'bg-blue-100 dark:bg-blue-900/50 border border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200 p-3 rounded-lg flex justify-between items-center';
                timerEl.innerHTML = `<span>üò¥ Slaapje bezig</span><span class="font-mono font-semibold" id="display-timer-slaap">00:00:00</span>`;
                activeTimersEl.appendChild(timerEl);
                
                const updateDisplay = () => updateTimerDisplay('display-timer-slaap', startTime);
                updateDisplay();
                localTimerInterval = setInterval(updateDisplay, 1000);
            }
        }
        
        function updateSlaapButton(timers = {}) {
            const slaapBtn = document.getElementById('slaapBtn');
            const textEl = slaapBtn.querySelector('span:last-child');
            const isSlapen = timers.slaap && timers.slaap.startTime;
            slaapBtn.classList.toggle('bg-red-200', isSlapen);
            slaapBtn.classList.toggle('dark:bg-red-800/50', isSlapen);
            textEl.textContent = isSlapen ? 'Stop Slaap' : 'Slaap';
        }

        // --- DATABASE ACTIES ---
        async function addToLog(type, data, customTimestamp = null) {
            const logsRef = collection(db, `artifacts/${appId}/public/data/families_public/${familyId}/logs`);
            const timestamp = customTimestamp ? customTimestamp : serverTimestamp();
            await addDoc(logsRef, { timestamp, type, data });
        }

        async function startSlaapTimer() {
            const timersRef = doc(db, `artifacts/${appId}/public/data/families_public/${familyId}/state/timers`);
            await setDoc(timersRef, { slaap: { startTime: serverTimestamp() } });
        }

        async function stopSlaapTimer() {
            const timersRef = doc(db, `artifacts/${appId}/public/data/families_public/${familyId}/state/timers`);
            const timerDoc = await getDoc(timersRef);
            const timerData = timerDoc.data();
            if (!timerData || !timerData.slaap) return;

            const startTime = timerData.slaap.startTime.toDate();
            const duration = Math.floor((new Date() - startTime) / 1000);
            await addToLog('SLAAP', { duration });
            await setDoc(timersRef, { slaap: null });
        }
        
        // --- EVENT HANDLERS ---
        document.getElementById('slaapBtn').addEventListener('click', async () => {
            const timersRef = doc(db, `artifacts/${appId}/public/data/families_public/${familyId}/state/timers`);
            const timerDoc = await getDoc(timersRef);
            if (timerDoc.data()?.slaap) {
                stopSlaapTimer();
            } else {
                startSlaapTimer();
            }
        });
        
        document.getElementById('songBtn').addEventListener('click', () => {
            if (isLullabyPlaying) {
                stopLullabyCallback();
            } else {
                playLullaby();
            }
        });
        
        logbookEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-log-item');
            if (deleteButton) {
                const idToDelete = deleteButton.dataset.id;
                document.getElementById('confirmDeleteBtn').dataset.id = idToDelete;
                openModal(modals.confirmDelete);
            }
        });
        
        ['voedingBtn', 'kolfBtn', 'luierBtn', 'metingBtn', 'noiseBtn', 'summaryBtn'].forEach(id => {
            document.getElementById(id).addEventListener('click', () => {
                if(familyId) {
                    const modalKey = id.replace('Btn', '');
                    openModal(modals[modalKey]);
                }
            });
        });

        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', closeModal));
        modalContainer.addEventListener('click', (e) => { if (e.target === modalContainer) closeModal(); });

        document.getElementById('confirmDeleteBtn').addEventListener('click', async (e) => {
            const idToDelete = e.target.dataset.id;
            if (idToDelete) {
                const docRef = doc(db, `artifacts/${appId}/public/data/families_public/${familyId}/logs/${idToDelete}`);
                await deleteDoc(docRef);
                closeModal();
            }
        });
        
        document.getElementById('saveFles').addEventListener('click', () => {
            const ml = parseInt(document.getElementById('flesMl').value);
            const hoursInput = document.getElementById('flesTijdUur').value;
            const minutesInput = document.getElementById('flesTijdMinuut').value;
            const dateInput = document.getElementById('flesDatum').value;

            if (ml > 0 && hoursInput !== '' && minutesInput !== '' && dateInput) {
                const hours = parseInt(hoursInput, 10);
                const minutes = parseInt(minutesInput, 10);
                if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                    const customDate = new Date(`${dateInput}T${hoursInput.padStart(2,'0')}:${minutesInput.padStart(2,'0')}`);
                    addToLog('VOEDING_FLES', { ml }, customDate);
                    closeModal();
                }
            }
        });

         document.getElementById('saveKolf').addEventListener('click', () => {
            const ml = parseInt(document.getElementById('kolfMl').value);
            const hoursInput = document.getElementById('kolfTijdUur').value;
            const minutesInput = document.getElementById('kolfTijdMinuut').value;
            const dateInput = document.getElementById('kolfDatum').value;

            if (ml > 0 && hoursInput !== '' && minutesInput !== '' && dateInput) {
                const hours = parseInt(hoursInput, 10);
                const minutes = parseInt(minutesInput, 10);
                if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                    const customDate = new Date(`${dateInput}T${hoursInput.padStart(2,'0')}:${minutesInput.padStart(2,'0')}`);
                    addToLog('KOLF', { ml }, customDate);
                    closeModal();
                }
            }
        });
        
        document.querySelectorAll('.luier-keuze-btn').forEach(btn => {
            btn.addEventListener('click', () => { addToLog('LUIER', { type: btn.dataset.type }); closeModal(); });
        });
        
        document.getElementById('saveMeting').addEventListener('click', () => {
            const gewicht = parseInt(document.getElementById('gewichtInput').value) || null;
            const lengte = parseInt(document.getElementById('lengteInput').value) || null;
            if (gewicht || lengte) { addToLog('METING', { gewicht, lengte }); closeModal(); }
        });
        
        // --- MODAL FUNCTIES ---
        function openModal(modal) {
            modalContainer.style.display = 'flex';
            modal.style.display = 'block';
            if (modal === modals.voeding || modal === modals.kolf) {
                const now = new Date();
                const dateInput = modal === modals.voeding ? 'flesDatum' : 'kolfDatum';
                const hourInput = modal === modals.voeding ? 'flesTijdUur' : 'kolfTijdUur';
                const minuteInput = modal === modals.voeding ? 'flesTijdMinuut' : 'kolfTijdMinuut';
                
                document.getElementById(dateInput).valueAsDate = now;
                document.getElementById(hourInput).value = now.getHours().toString().padStart(2, '0');
                document.getElementById(minuteInput).value = now.getMinutes().toString().padStart(2, '0');
            }
            if(modal === modals.summary) {
                generateSummary();
            }
        }

        function closeModal() {
            modalContainer.style.display = 'none';
            Object.values(modals).forEach(m => m.style.display = 'none');
             if(isNoisePlaying) { // Stop noise when any modal closes
                toggleWhiteNoise();
            }
        }
        
        // --- DARK MODE ---
        darkModeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            updateDarkModeIcons(isDark);
        });
        
        function setupDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true' || 
                           (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            document.documentElement.classList.toggle('dark', isDark);
            updateDarkModeIcons(isDark);
        }
        
        function updateDarkModeIcons(isDark) {
            sunIcon.classList.toggle('hidden', isDark);
            moonIcon.classList.toggle('hidden', !isDark);
        }
        
        // --- HELPER FUNCTIES ---
        function formatDuration(totalSeconds) {
            if (totalSeconds < 60) return `${Math.floor(totalSeconds)}s`;
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            return (h > 0 ? `${h}u ` : '') + `${m}m`;
        }
        
        function updateTimerDisplay(displayId, startTime) {
            const display = document.getElementById(displayId);
            if (!display) return;
            const elapsed = Math.max(0, Math.floor((new Date() - startTime) / 1000));
            const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (elapsed % 60).toString().padStart(2, '0');
            display.textContent = `${h}:${m}:${s}`;
        }

        // --- GEMINI API FUNCTIE ---
        async function generateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `<p>Een momentje, ik analyseer de dag van Barlas...</p>`;

            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const recentLogs = currentLogs.filter(log => log.timestamp && log.timestamp.toDate() > twentyFourHoursAgo);

            if (recentLogs.length < 3) {
                summaryContent.innerHTML = `<p>Er zijn nog niet genoeg activiteiten gelogd in de laatste 24 uur om een goede samenvatting te maken.</p>`;
                return;
            }

            const logText = recentLogs.map(log => {
                const time = log.timestamp.toDate().toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });
                return `- ${time}: ${getLogItemContent(log).text}`;
            }).join('\n');

            const systemPrompt = "Je bent een vriendelijke en ondersteunende baby-assistent. Geef een korte, positieve en geruststellende samenvatting van de dag van een baby op basis van het logboek. Spreek de ouders direct aan (met 'jullie'). Noem de totale slaapduur, het aantal voedingen en eventuele opvallende patronen. Gebruik eenvoudige taal. Geef geen medisch advies. Formatteer je antwoord netjes met kopjes en witregels.";
            const userQuery = `Hier is het logboek van baby Barlas voor de afgelopen 24 uur. Maak alsjeblieft een samenvatting voor de ouders.\n\n${logText}`;
            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    })
                });

                if (!response.ok) throw new Error(`API verzoek mislukt met status: ${response.status}`);

                const result = await response.json();
                const summary = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (summary) {
                    summaryContent.innerHTML = summary.replace(/\n/g, '<br>');
                } else {
                    summaryContent.innerHTML = `<p>Sorry, ik kon op dit moment geen samenvatting genereren.</p>`;
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                summaryContent.innerHTML = `<p>Oeps, er ging iets mis. Controleer je internetverbinding en probeer het opnieuw.</p>`;
            }
        }
    </script>
</body>
</html>

